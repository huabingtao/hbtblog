(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{404:function(s,n,a){"use strict";a.r(n);var t=a(6),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("你好，这是一篇入门级前后端分离的全栈教程。前端用"),a("strong",[s._v("React")]),s._v("构建，后端"),a("strong",[s._v("Node + Koa2")]),s._v(" 使用"),a("strong",[s._v("Sequelize")]),s._v("链接数据库，数据库采用 "),a("strong",[s._v("mysql")]),s._v(" 虽然是入门级但还是希望你了解过 React 和 Node 本篇不会对如 react 组件、Node.js 模块、koa 路由、koa 中间件等基本内容作详细讲解，由于时间关系 ui 样式不作为本次学习的重点使用了 antd-mobil 框架。")]),s._v(" "),a("h1",{attrs:{id:"项目截图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目截图"}},[s._v("#")]),s._v(" 项目截图")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/1.jpeg",alt:""}})]),s._v(" "),a("h1",{attrs:{id:"源码获取"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码获取"}},[s._v("#")]),s._v(" 源码获取")]),s._v(" "),a("p",[a("a",{attrs:{href:"http://github.com/huabingtao/react-diary",target:"_blank",rel:"noopener noreferrer"}},[s._v("react 前端源码"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"http://github.com/huabingtao/koa-diary",target:"_blank",rel:"noopener noreferrer"}},[s._v("node+koa2 后端源码"),a("OutboundLink")],1)]),s._v(" "),a("h1",{attrs:{id:"node-后端开发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-后端开发"}},[s._v("#")]),s._v(" Node 后端开发")]),s._v(" "),a("h2",{attrs:{id:"环境安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境安装"}},[s._v("#")]),s._v(" 环境安装")]),s._v(" "),a("ul",[a("li",[s._v("mysql 的版本号: mysql-5.7.27")]),s._v(" "),a("li",[s._v("node 的版本号 : 10.15.3")]),s._v(" "),a("li",[s._v("Navicat 是数据库可视化工具方便我们查看数据库中的表，同学们选择进行安装。")]),s._v(" "),a("li",[s._v("Postman 用于调试接口的工具。")])]),s._v(" "),a("h2",{attrs:{id:"node-初体验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-初体验"}},[s._v("#")]),s._v(" Node 初体验")]),s._v(" "),a("h3",{attrs:{id:"_1-创建项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建项目"}},[s._v("#")]),s._v(" 1) 创建项目")]),s._v(" "),a("p",[s._v("新建文件夹 koa-diary 在文件夹下新建 "),a("strong",[s._v("package.json")]),s._v(" 写入")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"koa-diary"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"main"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"index.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"license"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"MIT"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"devDependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"koa"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^2.7.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"koa-bodyparser"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^4.2.1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"koa-router"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^7.4.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lodash"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^4.17.11"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"mysql2"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^1.6.5"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"require-directory"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^2.1.1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"sequelize"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^5.6.1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"validator"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^10.11.0"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodemon --inspect-brk"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start:prod"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node app.js"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"dependencies"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"koa2-cors"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^2.0.6"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"loadsh"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.4"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("执行 "),a("strong",[s._v("yarn")]),s._v(" 或者 "),a("strong",[s._v("npm install")]),s._v(" 安装依赖\n这些依赖到用到的时候再去解释先冲就完事了！！！🤣")]),s._v(" "),a("h3",{attrs:{id:"_2-第一个-node-程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-第一个-node-程序"}},[s._v("#")]),s._v(" 2) 第一个 node 程序")]),s._v(" "),a("p",[s._v("我们一般程序主入口会放在根目录下，新建 app.js 添加代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// app.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"koa"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"listen 3000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("打开命令行执行 "),a("code",[s._v("node app.js")])]),s._v(" "),a("p",[s._v("如果终端有打印 "),a("code",[s._v("listen 3000")]),s._v(" node 监听了 3000 端口，接下来打开浏览器输入 "),a("em",[s._v("http://localhost:3000/")]),s._v(" 如果浏览器返回如图")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/2.jpeg",alt:""}}),s._v("\n说明我们的服务器已经成功启动了但为什么返回 "),a("strong",[s._v("Not Found")]),s._v(" 因为我们的服务确实是什么都没返回啊！！！！")]),s._v(" "),a("p",[s._v("接下来我们写点东西让 node 返回点东西给前端! "),a("strong",[s._v("app.js")]),s._v(" 修改后")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\napp.use(async (ctx, next) => {\n  ctx.response.body = '<h1>Hello, koa2!</h1>'\n})\n\napp.listen(3000)\nconsole.log('listen 3000')\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("再次访问"),a("em",[s._v("http://localhost:3000/")]),s._v(" 不出意外你会看到")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/3.jpeg",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_3-使用-koa-router"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用-koa-router"}},[s._v("#")]),s._v(" 3) 使用 koa-router")]),s._v(" "),a("p",[s._v("打开 "),a("strong",[s._v("app.js")]),s._v(" 增加几行代码")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa')\nconst Router = require('koa-router')\nconst router = new Router()\nconst app = new Koa()\nrouter.get('/hello', (ctx, next) => {\n  ctx.body = 'hello koa'\n})\napp.use(router.routes())\napp.listen(3000)\nconsole.log('listen 3000')\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("打开浏览器访问 http://localhost:3000/hello 不出意外如下图所示:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/4.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("浏览器输出了 hello koa 用 koa-router 写接口要比 node 原生的更"),a("strong",[s._v("简洁")])]),s._v(" "),a("p",[a("strong",[s._v("这难道就是传说中的接口吗？？大佬大佬！！")])]),s._v(" "),a("p",[s._v("接下来我们就要进行实战了，如果看到这里你还是有点吃力的话建议你去把"),a("strong",[s._v("Node.js")]),s._v("以及"),a("strong",[s._v("koa2")]),s._v("基础补一下再来食用哦 😏")]),s._v(" "),a("h3",{attrs:{id:"_4-使用-nodemon-监控进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-使用-nodemon-监控进程"}},[s._v("#")]),s._v(" 4) 使用 nodemon 监控进程")]),s._v(" "),a("p",[a("strong",[s._v("nodemon")]),s._v("是一款监控进程的工具\nnodemon 可以让我们改变代码后不需要手动重启服务，它会在我们改变代码后自动重启服务。")]),s._v(" "),a("p",[s._v("1 全局安装 nodemon\n"),a("code",[s._v("yarn add nodemon -g")])]),s._v(" "),a("p",[s._v("2 打开 vscode 点击左边的爬虫选择创建"),a("strong",[s._v("lunch.json")]),s._v("文件，接着选择 Node.js 环境")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/5.jpeg",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/6.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("3 打开"),a("strong",[s._v("lunch.js")]),s._v("文件 把配置改为"),a("strong",[s._v("nodemon")]),s._v(" 去监听进程")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 使用 IntelliSense 了解相关属性。")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 悬停以查看现有属性的描述。")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 欲了解更多信息，请访问: http://go.microsoft.com/fwlink/?linkid=830387")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.2.0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"configurations"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"request"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"launch"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodemon"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"runtimeExecutable"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodemon"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"program"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${workspaceFolder}/app.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"restart"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"console"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"integratedTerminal"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"internalConsoleOptions"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"neverOpen"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"request"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"launch"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"启动程序"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"program"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${workspaceFolder}/app.js"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("4 配置完成后把选项切换为"),a("strong",[s._v("nodemon")]),s._v(" 点击调试按钮就是那个播放按钮")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/7.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("如果你看到控制台有如下输出，那么 nodemon 已经运行成功了。")]),s._v(" "),a("p",[s._v("现在你随便改几行代码保存一下就会发现"),a("strong",[s._v("nodemon")]),s._v("在自动帮我们重启，偷懒的感觉怎么样。")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/8.jpeg",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_5-构建项目目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-构建项目目录"}},[s._v("#")]),s._v(" 5) 构建项目目录")]),s._v(" "),a("p",[s._v("一个好的的项目必须要有合理的目录，新建如下图一些文件夹。")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/9.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("接下来会和大家解释这些目录的用处不要捉急！！😸😸")]),s._v(" "),a("h3",{attrs:{id:"_6-全局动态注册路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-全局动态注册路由"}},[s._v("#")]),s._v(" 6) 全局动态注册路由")]),s._v(" "),a("p",[s._v("目前我们是采取"),a("code",[s._v("app.use(router.routes())")]),s._v("的方式手动去注册路由。而且这很不"),a("strong",[s._v("优雅")]),s._v("但是真实的开发场景路由一般会多达几十个甚至上百个再去手动的方式注册路由就显得有点蠢了，我们鼓励程序员 “偷懒” 这能让我们的代码看上去更"),a("strong",[s._v("简洁")])]),s._v(" "),a("p",[s._v("第一步 在 app 目录下新建 api 文件夹用于存放所有 api\n第二步 在 api 文件夹下新建"),a("strong",[s._v("test.js")]),s._v("写入如下代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/test.js\nconst Router = require('koa-router')\nconst router = new Router({\n  prefix: '/test'\n})\nrouter.get('/', async ctx => {\n  ctx.body = '测试'\n})\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("第三步 在根目录下的 core 文件夹下新建 "),a("strong",[s._v("init.js")]),s._v(" 写入如下代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// core/init.js\nconst Router = require('koa-router')\nconst Directory = require('require-directory')\n\nclass InitManager {\n  static initCore(app) {\n    InitManager.app = app\n    InitManager.initLoadRouters()\n  }\n\n  static initLoadRouters() {\n    function checkRouter(obj) {\n      if (obj instanceof Router) {\n        InitManager.app.use(obj.routes())\n      }\n    }\n    const path = process.cwd()\n    Directory(module, `${path}/app/api`, { visit: checkRouter })\n  }\n}\n\nmodule.exports = InitManager\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("第四步 改造"),a("strong",[s._v("app.js")]),s._v(" 重启程序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// app.js\nconst Koa = require('koa')\nconst InitManager = require('./core/init')\nconst app = new Koa()\nInitManager.initCore(app)\napp.listen(3000)\nconsole.log('listen 3000')\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("打开 http://localhost:3000/test 不出意外的话浏览器显示如下图:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/10.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("现在我们已经可以完成"),a("strong",[s._v("动态注册路由")]),s._v("了，只要我们把路由写在"),a("strong",[s._v("api")]),s._v("文件夹下程序就会自动帮我们注册。")]),s._v(" "),a("h3",{attrs:{id:"_7-全局异常捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-全局异常捕获"}},[s._v("#")]),s._v(" 7) 全局异常捕获")]),s._v(" "),a("p",[s._v("当我们程序出了故障应该明确地提示给前端用户也方便我们调试代码。我们使用"),a("strong",[s._v("中间件")]),s._v("的方式写全局异常捕获，这需要了解"),a("strong",[s._v("koa2")]),s._v("著名的"),a("strong",[s._v("洋葱模型")]),s._v("，因为不是本节课重点所以不会详细讲解它。如果不懂什么是洋葱模型的话一定要先去了解清楚！！")]),s._v(" "),a("p",[s._v("第一步 在 config 文件夹下新建 "),a("strong",[s._v("config.js")]),s._v(" 写入代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// config/config.js\nmodule.exports = {\n  // prod\n  environment: 'dev'\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("第二步 打开 core 文件夹下的"),a("strong",[s._v("init.js")]),s._v(" 完整代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// core/init.js\nconst Router = require('koa-router')\nconst Directory = require('require-directory')\n\nclass InitManager {\n  static initCore(app) {\n    InitManager.app = app\n    InitManager.initLoadRouters()\n    InitManager.initLoadConfig()\n  }\n\n  static initLoadRouters() {\n    function checkRouter(obj) {\n      // console.log('obj', obj)\n\n      if (obj instanceof Router) {\n        InitManager.app.use(obj.routes())\n      }\n    }\n    const path = process.cwd()\n    Directory(module, `${path}/app/api`, { visit: checkRouter })\n  }\n\n  static initLoadConfig() {\n    const path = process.cwd() + '/config/config.js'\n    global.config = require(path)\n  }\n}\n\nmodule.exports = InitManager\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("p",[s._v("第二步 在 core 下新建"),a("strong",[s._v("http-exception.js")]),s._v(" 写入代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// core/http-exception.js\nclass HttpException extends Error {\n  constructor(msg = '服务器异常', code = 400, errorCode = 10001) {\n    super()\n    this.msg = msg\n    this.code = code\n    this.errorCode = errorCode\n  }\n}\n\nmodule.exports = {\n  HttpException\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("第三步 在根目录下的"),a("strong",[s._v("middlewares")]),s._v("文件夹下新建"),a("strong",[s._v("exception.js")]),s._v(" 写入代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// middlewares/exception.js\nconst { HttpException } = require('../core/http-exception')\nconst catchError = async (ctx, next) => {\n  try {\n    await next()\n  } catch (error) {\n    const isHttpException = error instanceof HttpException\n    const isDev = global.config.environment === 'dev'\n    if (isDev) {\n      if (!isHttpException) {\n        throw error\n      }\n    }\n\n    if (isHttpException) {\n      ctx.body = {\n        message: error.msg,\n        errorCode: error.errorCode,\n        requestUrl: `${ctx.method} ${ctx.path}`\n      }\n      ctx.status = error.code\n    } else {\n      ctx.body = {\n        message: '服务器发生了点问题请稍后再试',\n        errorCode: '9999',\n        requestUrl: `${ctx.method} ${ctx.path}`\n      }\n      ctx.status = 500\n    }\n  }\n}\n\nmodule.exports = catchError\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[s._v("第四步 修改"),a("strong",[s._v("app.js")]),s._v(" 完整代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// app.js\nconst Koa = require('koa')\nconst bodyParser = require('koa-bodyparser') // 获取Body参数\nconst InitManager = require('./core/init') //动态注册路由 || 全局挂载config\nconst catchError = require('./middlewares/exception') // 全局异常\nconst cors = require('koa2-cors') // 解决跨域\n\nconst app = new Koa()\n\napp.use(cors())\napp.use(catchError)\napp.use(bodyParser())\nInitManager.initCore(app)\napp.listen(3000)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("接下来我们修改下 api 文件夹下的 test.js 测试代码抛出一个服务端异常:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/test.js\nconst Router = require('koa-router')\n\nconst router = new Router({\n  prefix: '/test'\n})\n\nrouter.get('/', async ctx => {\n  throw new Error('抛出异常')\n  ctx.body = '测试'\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("刷新浏览器查看如果浏览器出现 Internal Server Error:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/11.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("打开控制台查看:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/12.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("我们已经成功捕获到了非"),a("strong",[s._v("http 异常")]),s._v("，一般这样的异常是不曝露给用户看到的研发自己知道就可以了。接下来我们用测试代码演示抛出一个"),a("strong",[s._v("http 异常")]),s._v("。")]),s._v(" "),a("p",[s._v("修改 "),a("strong",[s._v("test.js")]),s._v(" 修改后如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/test.js\nconst Router = require('koa-router')\nconst { HttpException } = require('../../core/http-exception')\n\nconst router = new Router({\n  prefix: '/test'\n})\n\nrouter.get('/', async ctx => {\n  // throw new Error('抛出异常')\n  throw new HttpException()\n  ctx.body = '测试'\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("刷新 http://localhost:3000/test 如图:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/13.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("此时我们已经成功捕获到了异常并成功返回给了前端。")]),s._v(" "),a("h2",{attrs:{id:"用户注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户注册"}},[s._v("#")]),s._v(" 用户注册")]),s._v(" "),a("blockquote",[a("p",[s._v("前面做了那么多,比如异常处理、全局动态注册路由、都是为了接口做准备的。")])]),s._v(" "),a("h4",{attrs:{id:"_1）mysql-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1）mysql-配置"}},[s._v("#")]),s._v(" 1）mysql 配置")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("config")]),s._v("文件下的 config.js 新增 mysql 配置代码如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// config.js\nmodule.exports = {\n  // prod\n  environment: 'dev',\n  database: {\n    dbName: 'remind',\n    host: 'localhost',\n    port: 3306,\n    user: 'root',\n    password: '123456'\n  }\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("我们通过"),a("strong",[s._v("sequelize.js")]),s._v("去操作数据库,在"),a("strong",[s._v("core")]),s._v("目录下新增文件"),a("strong",[s._v("db.js")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// db.js\nconst { Sequelize, Model } = require('sequelize')\nconst { unset, clone, isArray } = require('loadsh')\n\nconst {\n  dbName,\n  host,\n  port,\n  user,\n  password\n} = require('../config/config').database\nconst sequelize = new Sequelize(dbName, user, password, {\n  dialect: 'mysql', // 连接数据库\n  host,\n  port,\n  timezone: '+08:00',\n  define: {\n    logging: true,\n    timestamps: true, // 时间字段\n    paranoid: true, // 删除字段\n    createdAt: 'created_at',\n    updatedAt: 'updated_at',\n    deletedAt: 'deleted_at',\n    underscored: true, // 驼峰转化下划线\n    freezeTableName: true\n  }\n})\n\nsequelize.sync({\n  force: false\n})\n\nModel.prototype.toJSON = function() {\n  let data = clone(this.dataValues)\n  unset(data, 'updated_at')\n  unset(data, 'deleted_at')\n\n  if (isArray(this.exclude)) {\n    this.exclude.forEach(value => {\n      unset(data, value)\n    })\n  }\n\n  return data\n}\n\nmodule.exports = {\n  sequelize\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br")])]),a("p",[s._v("在"),a("strong",[s._v("api")]),s._v("目录下新建"),a("strong",[s._v("user.js")]),s._v("删除之前用于测试的 test.js,新增代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// user.js\nconst Router = require('koa-router')\n\nconst router = new Router({\n  prefix: '/user'\n})\nrouter.post('/register', async ctx => {\n\n})\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("blockquote",[a("p",[s._v("接着我们给用户注册写 "),a("strong",[s._v("校验器")]),s._v("，校验器也是通过中间件的方式去实现的。如果发生异常会直接被我们的全局异常所捕获到")])]),s._v(" "),a("p",[s._v("打来 core 目录的"),a("strong",[s._v("http-exception.js")]),s._v("新增"),a("strong",[s._v("ParameterException")]),s._v("异常修改如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// http-exception.js\nclass HttpException extends Error {\n  constructor(msg = '服务器异常', code = 400, errorCode = 10001) {\n    super()\n    this.msg = msg\n    this.code = code\n    this.errorCode = errorCode\n  }\n}\n\nclass ParameterException extends HttpException {\n  constructor(msg = '参数错误', errorCode) {\n    super()\n    this.msg = msg\n    this.errorCode = errorCode || 10001\n  }\n}\n\nmodule.exports = {\n  HttpException,\n  ParameterException\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("接下来在"),a("strong",[s._v("app")]),s._v("目录下新建文件夹"),a("strong",[s._v("validators")]),s._v("存放我们的校验器。在 validators 下新建"),a("strong",[s._v("validator.js")]),s._v(" 写入:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// validator.js\n\nconst validator = require('validator')\nconst { ParameterException } = require('../../core/http-exception')\n\nconst RegisterValidator = async function(ctx, next) {\n  const { email, password1, password2 } = ctx.request.body\n  let v = validator.isLength(email, { min: 6, max: 64 })\n  if (!v) {\n    throw new ParameterException('email长度必须在6~64个字符')\n  }\n  v = validator.isEmail(email)\n  if (!v) {\n    throw new ParameterException('email格式错误')\n  }\n  v = validator.isLength(password1, { min: 6, max: 32 })\n  if (!v) {\n    throw new ParameterException('密码至少6个字符，最多32个字符')\n  }\n  v = validator.isLength(password2, { min: 6, max: 32 })\n  if (!v) {\n    throw new ParameterException('密码至少6个字符，最多32个字符')\n  }\n  if (password1 !== password2) {\n    throw new ParameterException('两个密码必须相同')\n  }\n  await next()\n}\n\nmodule.exports = {\n  RegisterValidator\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[s._v("最后我们修改下 api 目录下的"),a("strong",[s._v("user.js")]),s._v(",把我们刚刚编写的校验器用上。修改后的 user.js:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// user.js\nconst Router = require('koa-router')\nconst { RegisterValidator } = require('../validators/validator')\n\nconst router = new Router({\n  prefix: '/user'\n})\n\nrouter.post('/register', RegisterValidator, async ctx => {})\n\nmodule.exports = router\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("运行 nodemon 在 postman 测试一下先输入一些错误的参数:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/14.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("可以看到校验器可以成功运行，接下来就是编写业务代码往数据库插入数据了。")]),s._v(" "),a("p",[s._v("我们通过模型的方式去操作数据库，在"),a("strong",[s._v("api")]),s._v("目录下新建"),a("strong",[s._v("models")]),s._v("文件夹，接着在 models 下新建"),a("strong",[s._v("user.js")]),s._v("写入代码:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// user.js\nconst { Model, DataTypes } = require('sequelize')\nconst { sequelize } = require('../../core/db')\n\nclass User extends Model {}\n\nUser.init(\n  {\n    id: {\n      type: DataTypes.INTEGER,\n      primaryKey: true,\n      autoIncrement: true\n    },\n    email: {\n      type: DataTypes.STRING,\n      unique: true\n    },\n    nickname: DataTypes.STRING,\n    password: DataTypes.STRING\n  },\n  {\n    sequelize,\n    tableName: 'user'\n  }\n)\n\nmodule.exports = {\n  User\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[s._v("先把异常类补充完整 "),a("strong",[s._v("http-exception.js")]),s._v(" 完整代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// http-exception.js\nclass HttpException extends Error {\n  constructor(msg = '服务器异常', code = 400, errorCode = 10001) {\n    super()\n    this.msg = msg\n    this.code = code\n    this.errorCode = errorCode\n  }\n}\n\nclass ParameterException extends HttpException {\n  constructor(msg = '参数错误', errorCode) {\n    super()\n    this.msg = msg\n    this.errorCode = errorCode || 10001\n  }\n}\n\nclass Success extends HttpException {\n  constructor(msg = 'ok') {\n    super()\n    this.msg = msg\n    this.code = 201\n    this.errorCode = 0\n  }\n}\n\nclass NotFound extends HttpException {\n  constructor(msg = '资源未找到', errorCode) {\n    super()\n    this.msg = msg\n    this.code = 401\n    this.errorCode = errorCode || 10002\n  }\n}\n\nclass EmailRepetition extends HttpException {\n  constructor(msg = '用户已存在') {\n    super()\n    this.msg = msg\n    this.code = 402\n    this.errorCode = 10003\n  }\n}\n\nclass LikeError extends HttpException {\n  constructor(msg = '你已经点过赞了', errorCode) {\n    super()\n    this.msg = msg\n    this.code = 402\n    this.errorCode = errorCode || 10004\n  }\n}\n\nmodule.exports = {\n  HttpException,\n  ParameterException,\n  Success,\n  NotFound,\n  EmailRepetition,\n  LikeError\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br")])]),a("p",[s._v("模型创建好之后打开"),a("strong",[s._v("api 目录下的 user.js")]),s._v(" 修改后代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// user.js\nconst Router = require('koa-router')\nconst { RegisterValidator } = require('../validators/validator')\nconst { EmailRepetition } = require('../../core/http-exception')\nconst { User } = require('../models/user')\n\nconst router = new Router({\n  prefix: '/user'\n})\n\nrouter.post('/register', RegisterValidator, async ctx => {\n  const { email, nickname, password1 } = ctx.request.body\n  const user = await User.findOne({\n    where: {\n      email\n    }\n  })\n  if (user) {\n    throw new EmailRepetition()\n  }\n  await User.create({ email, nickname, password: password1 })\n})\n\nmodule.exports = router\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("用 postman 调用一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/15.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("返回 Not Found 刷新下 user 表:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/16.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("这条记录已经产生我们还需要给客户端一个明确的成功提示")]),s._v(" "),a("p",[s._v("在"),a("strong",[s._v("app")]),s._v("目录下新建"),a("strong",[s._v("lib")]),s._v("文件夹新建帮助函数:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// lib/helper.js\nconst { Success } = require('../../core/http-exception')\nfunction success(msg) {\n  throw new Success(msg)\n}\n\nfunction formatDate(timeObj) {\n  const date = new Date(timeObj)\n  const y = date.getFullYear()\n  const m =\n    (date.getMonth() + 1).toString().length === 1\n      ? '0' + (date.getMonth() + 1)\n      : date.getMonth() + 1\n  const d =\n    date.getDate().toString().length === 1\n      ? '0' + date.getDate()\n      : date.getDate()\n  return y + '年' + m + '月' + d + '日'\n}\n\nmodule.exports = {\n  success,\n  formatDate\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("返回两个函数"),a("strong",[s._v("success")]),s._v("是这次我们需要的，formatDate 我们后面做日期格式化的时候会用到")]),s._v(" "),a("p",[s._v("改写"),a("strong",[s._v("api 文件夹下的 user.js")]),s._v("在操作成功后返回"),a("strong",[s._v("success")]),s._v("函数:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/user.js\nconst Router = require('koa-router')\nconst { RegisterValidator } = require('../validators/validator')\nconst { EmailRepetition } = require('../../core/http-exception')\nconst { success } = require('../lib/helper')\nconst { User } = require('../models/user')\n\nconst router = new Router({\n  prefix: '/user'\n})\n\nrouter.post('/register', RegisterValidator, async ctx => {\n  const { email, nickname, password1 } = ctx.request.body\n  const user = await User.findOne({\n    where: {\n      email\n    }\n  })\n  if (user) {\n    throw new EmailRepetition()\n  }\n  await User.create({ email, nickname, password: password1 })\n  success()\n})\n\nrouter.post('/login', async ctx => {\n  const { email, password } = ctx.request.body\n  const user = await User.validatorEmail(email, password)\n  ctx.body = {\n    user\n  }\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("p",[s._v("接着我们改变点参数通过"),a("strong",[s._v("postman")]),s._v("调用一下结果应该能正确返回:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/17.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("ok 成功地返回出了 "),a("strong",[s._v("message errorCode 和 requestUrl")])]),s._v(" "),a("p",[s._v("到目前为止我们终于写好了一个接口不容易啊 😂")]),s._v(" "),a("h2",{attrs:{id:"用户登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户登录"}},[s._v("#")]),s._v(" 用户登录")]),s._v(" "),a("blockquote",[a("p",[s._v("用户登录除了对用户邮箱和密码的校验，首先查询邮箱是否存在，其次再进行密码的比对。有兴趣的同学可以对密码进行加密更符合真实的开发场景。")])]),s._v(" "),a("p",[s._v("我们把对数据库的操作写在模型上,打开"),a("strong",[s._v("models 目录下的 user.js")]),s._v(" 代码如下:")]),s._v(" "),a("p",[s._v("新增了两个静态方法，"),a("em",[s._v("validatorUser")]),s._v("验证用户 id 是否存在 "),a("em",[s._v("validatorEmail")]),s._v(" 验证用户邮箱是否存在")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// models/user.js\nconst { Model, DataTypes, Sequelize } = require('sequelize')\nconst { sequelize } = require('../../core/db')\nconst { NotFound } = require('../../core/http-exception')\n\nclass User extends Model {\n  static async validatorUser(id) {\n    const user = await User.findOne({\n      where: {\n        id\n      }\n    })\n    if (!user) {\n      throw new NotFound('账号不存在')\n    }\n    return user\n  }\n\n  static async validatorEmail(email, password) {\n    const user = await User.findOne({\n      where: {\n        email\n      }\n    })\n    if (!user) {\n      throw new NotFound('账号不存在')\n    }\n    if (user.password !== password) {\n      throw new NotFound('密码错误')\n    }\n    return user\n  }\n}\n\nUser.init(\n  {\n    id: {\n      type: DataTypes.INTEGER,\n      primaryKey: true,\n      autoIncrement: true\n    },\n    email: {\n      type: DataTypes.STRING,\n      unique: true\n    },\n    nickname: DataTypes.STRING,\n    password: DataTypes.STRING\n  },\n  {\n    sequelize,\n    tableName: 'user'\n  }\n)\n\nmodule.exports = {\n  User\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br")])]),a("p",[s._v("接着打开"),a("strong",[s._v("api")]),s._v("目录下的 user.js 新增"),a("strong",[s._v("路由 login")]),s._v(":")]),s._v(" "),a("p",[s._v("这个路由就是调用了"),a("strong",[s._v("User")]),s._v("模型上的"),a("em",[s._v("validatorEmail")]),s._v("方法把查询到的 User 返回给前端。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/user.js\nconst Router = require('koa-router')\nconst { RegisterValidator } = require('../validators/validator')\nconst { EmailRepetition } = require('../../core/http-exception')\nconst { success } = require('../lib/helper')\nconst { User } = require('../models/user')\n\nconst router = new Router({\n  prefix: '/user'\n})\n\nrouter.post('/register', RegisterValidator, async ctx => {\n  const { email, nickname, password1 } = ctx.request.body\n  const user = await User.findOne({\n    where: {\n      email\n    }\n  })\n  if (user) {\n    throw new EmailRepetition()\n  }\n  await User.create({ email, nickname, password: password1 })\n  success()\n})\n\nrouter.post('/login', async ctx => {\n  const { email, password } = ctx.request.body\n  const user = await User.validatorEmail(email, password)\n  ctx.body = {\n    user\n  }\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("h2",{attrs:{id:"新增日记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新增日记"}},[s._v("#")]),s._v(" 新增日记")]),s._v(" "),a("blockquote",[a("p",[s._v("新增日记只需要前端传用户 id 和 content 内容，用户昵称我们可以根据用户 id 去 user 表里面去读，阅读数量和点赞数都是 0 可以设置默认值。")])]),s._v(" "),a("h3",{attrs:{id:"_1）新建-diary-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1）新建-diary-模型"}},[s._v("#")]),s._v(" 1）新建 diary 模型")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("models")]),s._v("下新建"),a("strong",[s._v("diary.js")]),s._v("：")]),s._v(" "),a("p",[s._v("定义表名和字段需要注意的是设置"),a("strong",[s._v("favor_nums")]),s._v("和"),a("strong",[s._v("look_nums")]),s._v("的默认值为 0，"),a("strong",[s._v("content")]),s._v("的长度大家可视情况。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// models/diary.js\n\nconst { Model, DataTypes } = require('sequelize')\nconst { sequelize } = require('../../core/db')\n\nclass Diary extends Model {}\n\nDiary.init(\n  {\n    uid: DataTypes.INTEGER,\n    nickname: DataTypes.STRING,\n    content: DataTypes.STRING(2000),\n    create_time: DataTypes.DATE,\n    favor_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    },\n    look_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    }\n  },\n  {\n    sequelize,\n    tableName: 'diary'\n  }\n)\n\nmodule.exports = {\n  Diary\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h3",{attrs:{id:"_2）编写-diary-校验器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2）编写-diary-校验器"}},[s._v("#")]),s._v(" 2）编写 diary 校验器")]),s._v(" "),a("blockquote",[a("p",[s._v("diary 对应的接口就比较多了因此校验器也比较多，日记的增删改查我们都要对参数进行校验。")])]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("validators")]),s._v("目录下的"),a("strong",[s._v("validator.js")]),s._v(" 完整代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// validators/validator.js\nconst validator = require('validator')\nconst { ParameterException } = require('../../core/http-exception')\n\nconst RegisterValidator = async function(ctx, next) {\n  const { email, password1, password2 } = ctx.request.body\n  let v = validator.isLength(email, { min: 6, max: 64 })\n  if (!v) {\n    throw new ParameterException('email长度必须在6~64个字符')\n  }\n  v = validator.isEmail(email)\n  if (!v) {\n    throw new ParameterException('email格式错误')\n  }\n  v = validator.isLength(password1, { min: 6, max: 32 })\n  if (!v) {\n    throw new ParameterException('密码至少6个字符，最多32个字符')\n  }\n  v = validator.isLength(password2, { min: 6, max: 32 })\n  if (!v) {\n    throw new ParameterException('密码至少6个字符，最多32个字符')\n  }\n  if (password1 !== password2) {\n    throw new ParameterException('两个密码必须相同')\n  }\n  await next()\n}\n\nconst DiaryValidator = async (ctx, next) => {\n  const { content } = ctx.request.body\n  if (content.length > 1000) {\n    throw new ParameterException('内容超过1000字')\n  }\n  await next()\n}\n\nconst GetDiaryValidator = async (ctx, next) => {\n  const { start, count } = ctx.request.query\n  if (!start || !count) {\n    await next()\n    return\n  }\n  let v = validator.isInt(start)\n  if (!v) {\n    throw new ParameterException('start不符合规范')\n  }\n  v = validator.isInt(count)\n  if (!v) {\n    throw new ParameterException('count不符合规范')\n  }\n  await next()\n}\n\nconst PutDiaryValidator = async (ctx, next) => {\n  const { content } = ctx.request.body\n  let v = validator.isEmpty(content)\n  if (v) {\n    throw new ParameterException('content不能为空')\n  }\n  await next()\n}\n\nconst PostFavorValidator = async (ctx, next) => {\n  const { uid, diary_id } = ctx.request.body\n  let v = validator.isInt(uid.toString())\n  if (!v) {\n    throw new ParameterException('uid 不符合规范')\n  }\n  v = validator.isInt(diary_id.toString())\n  if (!v) {\n    throw new ParameterException('diary_id 不符合规范')\n  }\n  await next()\n}\n\nmodule.exports = {\n  RegisterValidator,\n  DiaryValidator,\n  GetDiaryValidator,\n  PutDiaryValidator,\n  PostFavorValidator\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br")])]),a("h3",{attrs:{id:"_3）编写-diary-接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3）编写-diary-接口"}},[s._v("#")]),s._v(" 3）编写 diary 接口")]),s._v(" "),a("p",[s._v("接着在"),a("strong",[s._v("api")]),s._v("目录下新建"),a("strong",[s._v("diary.js")]),s._v(",新增日记的接口比较简单就是把用户输入的内容插到 diary 表里去。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/diary.js\n\nconst Router = require('koa-router')\nconst { DiaryValidator } = require('../validators/validator')\nconst { success } = require('../lib/helper')\nconst { User } = require('../models/user')\nconst { Diary } = require('../models/diary')\n\nconst router = new Router({\n  prefix: '/diary'\n})\n\nrouter.post('/', DiaryValidator, async ctx => {\n  const { id, content } = ctx.request.body\n  const user = await User.validatorUser(id)\n  const date = new Date()\n  await Diary.create({\n    uid: id,\n    content,\n    nickname: user.nickname,\n    create_time: date,\n    favor_num: 0\n  })\n  success()\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[a("strong",[s._v("postman")]),s._v("调用一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/18.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("刷新 Navicat 后新增一条记录")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/19.jpeg",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"查看日记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看日记"}},[s._v("#")]),s._v(" 查看日记")]),s._v(" "),a("p",[s._v("查看日记的功能比较简单，就是根据日记的 id 去 diary 表里取对应的记录就 ok。")]),s._v(" "),a("blockquote",[a("p",[s._v("需要注意的是我们还有一个阅读次数的功能。所以每查看一次我们就在对应记录下 look_nums 递增 1 次。")])]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("api")]),s._v("目录下的 diaryl.js 新增代码如下:")]),s._v(" "),a("p",[a("strong",[s._v("formatDate")]),s._v("函数对输出的时间戳转化为"),a("strong",[s._v("xxxx 年 xx 月 xx 日")]),s._v("格式。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/diary.js\nconst Router = require('koa-router')\nconst { DiaryValidator } = require('../validators/validator')\nconst { success } = require('../lib/helper')\nconst { User } = require('../models/user')\nconst { Diary } = require('../models/diary')\nconst { formatDate } = require('../lib/helper')\n\nconst router = new Router({\n  prefix: '/diary'\n})\n\nrouter.post('/', DiaryValidator, async ctx => {\n  const { id, content } = ctx.request.body\n  const user = await User.validatorUser(id)\n  const date = new Date()\n  await Diary.create({\n    uid: id,\n    content,\n    nickname: user.nickname,\n    create_time: date,\n    favor_num: 0\n  })\n  success()\n})\n\nrouter.get('/:id', async ctx => {\n  const { id } = ctx.params\n  const diary = await Diary.findOne({\n    where: {\n      id: parseInt(id)\n    }\n  })\n  if (!diary) {\n    throw new NotFound('文章未找到')\n  }\n  await diary.increment('look_nums', {\n    by: 1\n  })\n  diary.setDataValue('create_time', formatDate(diary.create_time))\n  ctx.body = diary\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br")])]),a("p",[s._v("使用"),a("strong",[s._v("postman")]),s._v("调用一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/20.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("ok 成功查出日记并且"),a("strong",[s._v("look_nums")]),s._v("也增加了 1。")]),s._v(" "),a("h2",{attrs:{id:"点赞日记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#点赞日记"}},[s._v("#")]),s._v(" 点赞日记")]),s._v(" "),a("p",[s._v("我们需要一个表来记录谁对这条日记进行的点赞，并且在日记的列表页面需要把这篇日记的点赞数量统计出来。")]),s._v(" "),a("h3",{attrs:{id:"_1）编写-favor-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1）编写-favor-模型"}},[s._v("#")]),s._v(" 1）编写 favor 模型")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("models")]),s._v("目录新建"),a("strong",[s._v("favor.js")]),s._v("，并创建静态方法"),a("strong",[s._v("increment")]),s._v("。\n首先查询是否这篇日记已经被点赞了，如果是"),a("strong",[s._v("则抛出异常")]),s._v("。如果没有被点赞则往"),a("strong",[s._v("favor")]),s._v("表里增加一条记录且为"),a("strong",[s._v("diary")]),s._v("表里的"),a("strong",[s._v("favor_nums")]),s._v("字段加 1，为了保持数据库数据一致性用了"),a("strong",[s._v("数据库事务")]),s._v("的方式。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const { Model, DataTypes } = require('sequelize')\nconst { sequelize } = require('../../core/db')\nconst { NotFound, LikeError } = require('../../core/http-exception')\nconst { User } = require('./user')\n\nclass Favor extends Model {\n  static async increment(uid, diary_id) {\n    await User.validatorUser(uid)\n    const f = await Favor.findOne({\n      where: {\n        uid,\n        diary_id\n      }\n    })\n    if (f) {\n      throw new LikeError()\n    }\n    return sequelize.transaction(async t => {\n      await Favor.create(\n        {\n          uid,\n          diary_id\n        },\n        { transaction: t }\n      )\n      const { Diary } = require('./diary')\n      const diary = await Diary.findOne({\n        where: {\n          id: diary_id\n        }\n      })\n      if (!diary) {\n        throw new NotFound('日记不存在')\n      }\n      await diary.increment('favor_nums', { by: 1, transaction: t })\n    })\n  }\n}\n\nFavor.init(\n  {\n    uid: DataTypes.INTEGER,\n    diary_id: DataTypes.INTEGER\n  },\n  {\n    sequelize,\n    tableName: 'favor'\n  }\n)\n\nmodule.exports = {\n  Favor\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br")])]),a("h3",{attrs:{id:"_2-编写点赞接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-编写点赞接口"}},[s._v("#")]),s._v(" 2) 编写点赞接口")]),s._v(" "),a("p",[s._v("老样子在"),a("strong",[s._v("api")]),s._v("目录下新建"),a("strong",[s._v("favor.js")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/favor.js\nconst Router = require('koa-router')\nconst { PostFavorValidator } = require('../validators/validator')\nconst { success } = require('../lib/helper')\nconst { Favor } = require('../models/favor')\n\nconst router = new Router({\n  prefix: '/favor'\n})\n\nrouter.post('/', PostFavorValidator, async ctx => {\n  const { uid, diary_id } = ctx.request.body\n  await Favor.increment(uid, diary_id)\n  success()\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("用"),a("strong",[s._v("postman")]),s._v("调试一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/21.jpeg",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("Navicate")]),s._v(" 刷新"),a("strong",[s._v("favor")]),s._v("表查看:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/22.jpeg",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"日记列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日记列表"}},[s._v("#")]),s._v(" 日记列表")]),s._v(" "),a("p",[s._v("分为两个列表，一个是所有的日记列表，一个是我的日记列表。需要注意的是前端的显示页面需要显示日记的点赞状态，点赞状态从"),a("strong",[s._v("favor")]),s._v("表里得到。")]),s._v(" "),a("h3",{attrs:{id:"我的日记列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#我的日记列表"}},[s._v("#")]),s._v(" 我的日记列表")]),s._v(" "),a("p",[s._v("我的日记列表逻辑需要用户"),a("strong",[s._v("id")]),s._v("查询，并且从 favor 表里查出当前用户 id 的点赞的日记然后取到 diary_id，再与从我的日记列表进行对比如果有纪录则说明这条日记被点赞了。")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("models")]),s._v("目录下的"),a("strong",[s._v("diary.js")]),s._v("新增静态方法"),a("strong",[s._v("getDiary")]),s._v(" 改变后的代码如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const { Model, DataTypes, Op } = require('sequelize')\nconst { sequelize } = require('../../core/db')\nconst { NotFound } = require('../../core/http-exception')\nconst { formatDate } = require('../lib/helper')\nconst { User } = require('./user')\nconst { Favor } = require('./favor')\n\nclass Diary extends Model {\n  static async getDiary(id, start = 0, count = 10) {\n    await User.validatorUser(id)\n    const favors = await Favor.findAll({\n      where: {\n        uid: id\n      }\n    })\n    const diaryIds = favors.map(f => {\n      return f.diary_id\n    })\n    const diary = await Diary.findAll({\n      order: [['id', 'DESC']],\n      where: {\n        uid: id\n      },\n      offset: parseInt(start),\n      limit: parseInt(count)\n    })\n    diary.forEach(item => {\n      item.dataValues.create_time = formatDate(item.dataValues.create_time)\n      if (diaryIds.includes(item.id)) {\n        item.dataValues.isFavor = 1\n      } else {\n        item.dataValues.isFavor = 0\n      }\n    })\n    return diary\n  }\n}\n\nDiary.init(\n  {\n    uid: DataTypes.INTEGER,\n    nickname: DataTypes.STRING,\n    content: DataTypes.STRING(2000),\n    create_time: DataTypes.DATE,\n    favor_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    },\n    look_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    }\n  },\n  {\n    sequelize,\n    tableName: 'diary'\n  }\n)\n\nmodule.exports = {\n  Diary\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br")])]),a("p",[s._v("打开"),a("strong",[s._v("api")]),s._v("目录下的"),a("strong",[s._v("diary.js")]),s._v(" 修改如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/diary.js\nconst Router = require('koa-router')\nconst {\n  DiaryValidator,\n  GetDiaryValidator\n} = require('../validators/validator')\nconst { NotFound } = require('../../core/http-exception')\nconst { success } = require('../lib/helper')\nconst { User } = require('../models/user')\nconst { Diary } = require('../models/diary')\nconst { formatDate } = require('../lib/helper')\n\nconst router = new Router({\n  prefix: '/diary'\n})\n\nrouter.post('/', DiaryValidator, async ctx => {\n  const { id, content } = ctx.request.body\n  const user = await User.validatorUser(id)\n  const date = new Date()\n  await Diary.create({\n    uid: id,\n    content,\n    nickname: user.nickname,\n    create_time: date,\n    favor_num: 0\n  })\n  success()\n})\n\nrouter.get('/myDiary', GetDiaryValidator, async ctx => {\n  const { id, start, count } = ctx.request.query\n  const diarys = await Diary.getDiary(id, start, count)\n  ctx.body = diarys\n})\n\nrouter.get('/:id', async ctx => {\n  xq\n  const { id } = ctx.params\n  const diary = await Diary.findOne({\n    where: {\n      id: parseInt(id)\n    }\n  })\n  if (!diary) {\n    throw new NotFound('文章未找到')\n  }\n  await diary.increment('look_nums', {\n    by: 1\n  })\n  diary.setDataValue('create_time', formatDate(diary.create_time))\n  ctx.body = diary\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br")])]),a("p",[s._v("用"),a("strong",[s._v("postman")]),s._v("测试一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/23.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("其中 "),a("strong",[s._v("isFavor")]),s._v(" 就是点赞状态：0 为没点赞 1 为点赞")]),s._v(" "),a("h3",{attrs:{id:"广场日记列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#广场日记列表"}},[s._v("#")]),s._v(" 广场日记列表")]),s._v(" "),a("p",[s._v("其实这俩日记列表功能比较类似，我们把逻辑比较复杂的写在模型上。")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("models")]),s._v("目录下"),a("strong",[s._v("diary.js")]),s._v(",新增"),a("strong",[s._v("getAllDiary")]),s._v("静态方法 更改后如下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// models/diary.js\n\nconst { Model, DataTypes, Op } = require('sequelize')\nconst { sequelize } = require('../../core/db')\nconst { NotFound } = require('../../core/http-exception')\nconst { formatDate } = require('../lib/helper')\nconst { User } = require('./user')\nconst { Favor } = require('./favor')\n\nclass Diary extends Model {\n  static async getDiary(id, start = 0, count = 10) {\n    await User.validatorUser(id)\n    const favors = await Favor.findAll({\n      where: {\n        uid: id\n      }\n    })\n    const diaryIds = favors.map(f => {\n      return f.diary_id\n    })\n    const diary = await Diary.findAll({\n      order: [['id', 'DESC']],\n      where: {\n        uid: id\n      },\n      offset: parseInt(start),\n      limit: parseInt(count)\n    })\n    diary.forEach(item => {\n      item.dataValues.create_time = formatDate(item.dataValues.create_time)\n      if (diaryIds.includes(item.id)) {\n        item.dataValues.isFavor = 1\n      } else {\n        item.dataValues.isFavor = 0\n      }\n    })\n    return diary\n  }\n\n\n  static async getAllDiary(start, count, uid) {\n    const diary = await Diary.findAll({\n      order: [['id', 'DESC']],\n      offset: parseInt(start),\n      limit: parseInt(count)\n    })\n\n    const favors = await Favor.findAll({\n      where: {\n        uid\n      }\n    })\n\n    const diaryIds = favors.map(f => {\n      return f.diary_id\n    })\n\n    diary.forEach(item => {\n      item.dataValues.create_time = formatDate(item.dataValues.create_time)\n      if (diaryIds.includes(item.id)) {\n        item.dataValues.isFavor = 1\n      } else {\n        item.dataValues.isFavor = 0\n      }\n    })\n    return diary\n  }\n}\n\nDiary.init(\n  {\n    uid: DataTypes.INTEGER,\n    nickname: DataTypes.STRING,\n    content: DataTypes.STRING(2000),\n    create_time: DataTypes.DATE,\n    favor_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    },\n    look_nums: {\n      type: DataTypes.INTEGER,\n      defaultValue: 0\n    }\n  },\n  {\n    sequelize,\n    tableName: 'diary'\n  }\n)\n\nmodule.exports = {\n  Diary\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br")])]),a("p",[s._v("打开"),a("strong",[s._v("api")]),s._v("目录下"),a("strong",[s._v("diary.js")]),s._v("新增查询广场日记的路由:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.get('/', GetDiaryValidator, async ctx => {\n  const { start = 0, count = 10, uid } = ctx.request.query\n  const diarys = await Diary.getAllDiary(start, count, uid)\n  ctx.body = diarys\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("strong",[s._v("postman")]),s._v("跑一下:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/24.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("到这里日记列表开发完成了还剩下删除日记更新日记两个功能大家加油！")]),s._v(" "),a("h2",{attrs:{id:"更新日记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新日记"}},[s._v("#")]),s._v(" 更新日记")]),s._v(" "),a("p",[s._v("更新日记的逻辑比较简单直接看代码:")]),s._v(" "),a("p",[s._v("打开"),a("strong",[s._v("models")]),s._v("目录下"),a("strong",[s._v("diary.js")]),s._v("新增 updateDiary 方法:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("static async updateDiary(uid, id, content) {\nawait User.validatorUser(uid)\nconst diary = await Diary.update(\n  {\n    content\n  },\n  {\n    where: {\n      id\n    }\n  }\n)\nreturn diary\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("接着新增接口在"),a("strong",[s._v("api")]),s._v("目录下的"),a("strong",[s._v("diary.js")]),s._v("新增:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// api/diary.js\nrouter.put('/', PutDiaryValidator, async ctx => {\n  const { uid, id, content } = ctx.request.body\n  await Diary.updateDiary(uid, id, content)\n  success()\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("用 postman 运行:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/25.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("更新成功")]),s._v(" "),a("h2",{attrs:{id:"删除日记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除日记"}},[s._v("#")]),s._v(" 删除日记")]),s._v(" "),a("p",[s._v("删除日记的逻辑就比较简单了，只要找到对应日记 id 删除就行。需要注意的是数据库有"),a("strong",[s._v("软删除和硬删除两种")]),s._v(" 。软删除是不删除记录另外给此条记录增加一个删除日期，硬删除就是去真正的删除这条记录，我们选择硬删除。")]),s._v(" "),a("p",[s._v("创建模型打开"),a("strong",[s._v("models")]),s._v("目录下的"),a("strong",[s._v("diary.js")]),s._v("增加删除方法:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// models/diary.js\n\nstatic async deleteDiary(uid, id) {\n    await User.validatorUser(uid)\n    const diary = await Diary.destroy({\n      force: true, // 硬删除\n      where: {\n        id\n      }\n    })\n    return diary\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("打开"),a("strong",[s._v("api")]),s._v("目录下 diary.js 新增:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.delete('/', async ctx => {\n  const { uid, id } = ctx.request.body\n  await Diary.deleteDiary(uid, id)\n  success()\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("运行 postman 调用接口:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/26.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("刷新 Navicate:")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://file.huabingtao.com/juejin/nodeKoa/27.jpeg",alt:""}})]),s._v(" "),a("p",[s._v("删除日记成功！")]),s._v(" "),a("h1",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("到这里后端部分已经结束了，我相信如果你认真看完肯定会有收获的。我们简单总结下学到了哪些东西：")]),s._v(" "),a("ul",[a("li",[s._v("全局动态注册路由")]),s._v(" "),a("li",[s._v("使用中间件去处理异常")]),s._v(" "),a("li",[s._v("使用 Sequelize 操作数据库")]),s._v(" "),a("li",[s._v("使用 async 语法，同步的方式处理异步")]),s._v(" "),a("li",[s._v("结构化组件化开发项目")])]),s._v(" "),a("p",[s._v("最后，感谢您阅读这篇文章，有任何问题或反馈请给我留言。")])])}),[],!1,null,null,null);n.default=e.exports}}]);